name: ğŸ“Š Performance Monitoring

on:
  schedule:
    # Run performance checks daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual triggering

jobs:
  performance-audit:
    name: ğŸ” Website Performance Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ğŸ—ï¸ Build Production Site
      run: npm run build
      
    - name: ğŸš€ Start Local Server
      run: |
        cd dist
        npx serve . &
        sleep 10
        
    - name: ğŸ” Run Lighthouse Performance Audit
      uses: treosh/lighthouse-ci-action@v10
      with:
        configPath: './lighthouserc.json'
        uploadArtifacts: true
        temporaryPublicStorage: true
        
    - name: ğŸ“Š Performance Report
      run: |
        echo "ğŸ“Š Performance audit completed"
        echo "ğŸ”— Check Lighthouse reports in the action artifacts"

  security-scan:
    name: ğŸ›¡ï¸ Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ğŸ” Security Audit
      run: |
        npm audit --audit-level=moderate
        
    - name: ğŸ›¡ï¸ Dependency Vulnerability Check
      uses: actions/dependency-review-action@v4
      if: github.event_name == 'pull_request'

  uptime-check:
    name: â° Website Uptime Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸŒ Check Website Status
      run: |
        # Replace with your actual domain
        DOMAIN="https://kishanskraft.com/"
        
        echo "ğŸ” Checking website uptime..."
        
        # Check main pages
        PAGES=("/" "/products.html" "/about.html" "/contact.html")
        
        for page in "${PAGES[@]}"; do
          echo "Checking: $DOMAIN$page"
          status_code=$(curl -o /dev/null -s -w "%{http_code}" "$DOMAIN$page")
          
          if [ $status_code -eq 200 ]; then
            echo "âœ… $page - OK ($status_code)"
          else
            echo "âŒ $page - FAILED ($status_code)"
            exit 1
          fi
        done
        
        echo "ğŸ‰ All pages are up and running!"

  seo-check:
    name: ğŸ” SEO Health Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ğŸ—ï¸ Build Production Site
      run: npm run build
      
    - name: ğŸ” Check SEO Elements
      run: |
        echo "ğŸ” Checking SEO elements..."
        
        # Check for essential SEO elements in built files
        FILES=("dist/index.html" "dist/products.html" "dist/about.html" "dist/contact.html")
        
        for file in "${FILES[@]}"; do
          echo "Checking: $file"
          
          # Check for title tag
          if grep -q "<title>" "$file"; then
            echo "âœ… Title tag found"
          else
            echo "âŒ Missing title tag"
            exit 1
          fi
          
          # Check for meta description
          if grep -q 'name="description"' "$file"; then
            echo "âœ… Meta description found"
          else
            echo "âŒ Missing meta description"
            exit 1
          fi
          
          # Check for Open Graph tags
          if grep -q 'property="og:' "$file"; then
            echo "âœ… Open Graph tags found"
          else
            echo "âŒ Missing Open Graph tags"
            exit 1
          fi
        done
        
        # Check sitemap exists
        if [ -f "dist/sitemap.xml" ]; then
          echo "âœ… Sitemap found"
        else
          echo "âŒ Missing sitemap.xml"
          exit 1
        fi
        
        # Check robots.txt exists
        if [ -f "dist/robots.txt" ]; then
          echo "âœ… Robots.txt found"
        else
          echo "âŒ Missing robots.txt"
          exit 1
        fi
        
        echo "ğŸ‰ SEO check completed successfully!"