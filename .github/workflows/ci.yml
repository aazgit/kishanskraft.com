name: âœ… CI - Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: ğŸ—ï¸ Build and Validate
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18, 20]
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ğŸ” Security Audit
      run: npm audit --audit-level=high --production
      continue-on-error: true
      
    - name: ğŸ—ï¸ Build Production Site
      run: npm run build
      
    - name: ğŸ§ª Validate Build Output
      run: |
        echo "ğŸ” Validating build output..."
        
        # Check if essential files exist
        test -f dist/index.html || (echo "âŒ Missing index.html" && exit 1)
        test -f dist/products.html || (echo "âŒ Missing products.html" && exit 1)
        test -f dist/about.html || (echo "âŒ Missing about.html" && exit 1)
        test -f dist/contact.html || (echo "âŒ Missing contact.html" && exit 1)
        test -f dist/404.html || (echo "âŒ Missing 404.html" && exit 1)
        test -f dist/assets/css/style.css || (echo "âŒ Missing CSS file" && exit 1)
        test -f dist/assets/js/site.js || (echo "âŒ Missing JS file" && exit 1)
        test -f dist/sw.js || (echo "âŒ Missing service worker" && exit 1)
        test -f dist/manifest.json || (echo "âŒ Missing PWA manifest" && exit 1)
        test -f dist/sitemap.xml || (echo "âŒ Missing sitemap" && exit 1)
        test -f dist/robots.txt || (echo "âŒ Missing robots.txt" && exit 1)
        
        echo "âœ… All essential files present!"
        
        # Check file sizes
        echo "ğŸ“Š Build size analysis:"
        du -sh dist/
        du -sh dist/assets/
        
        # List all files
        echo "ğŸ“‚ Built files:"
        find dist/ -type f -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.json" | sort
        
    - name: ğŸ“Š Bundle Analysis
      run: |
        echo "ğŸ“Š Analyzing bundle sizes..."
        npm run analyze || echo "Bundle analysis completed"
        
    - name: ğŸ§ª Basic Functionality Test
      run: |
        echo "ğŸ§ª Testing basic functionality..."
        
        # Start a local server
        cd dist
        npx serve . &
        SERVER_PID=$!
        
        # Wait for server to start
        sleep 5
        
        # Test if pages are accessible
        curl -f http://localhost:3000/ || (echo "âŒ Homepage not accessible" && exit 1)
        curl -f http://localhost:3000/products.html || (echo "âŒ Products page not accessible" && exit 1)
        curl -f http://localhost:3000/about.html || (echo "âŒ About page not accessible" && exit 1)
        curl -f http://localhost:3000/contact.html || (echo "âŒ Contact page not accessible" && exit 1)
        
        # Clean up
        kill $SERVER_PID
        
        echo "âœ… All pages are accessible!"
        
    - name: ğŸ“¤ Upload Build Artifacts
      if: matrix.node-version == 20
      uses: actions/upload-artifact@v4
      with:
        name: production-build
        path: dist/
        retention-days: 7
        
    - name: âœ… Build Success Summary
      run: |
        echo "## âœ… Build Completed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ—ï¸ Build Details (Node.js ${{ matrix.node-version }})" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Dependencies installed successfully" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Security audit completed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Production build generated" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… All essential files validated" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Basic functionality tested" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ matrix.node-version }}" == "20" ]; then
          echo "### ğŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Production build uploaded as artifact" >> $GITHUB_STEP_SUMMARY
          echo "- Ready for manual deployment" >> $GITHUB_STEP_SUMMARY
        fi

  quality-checks:
    name: ğŸ” Quality Assurance
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: production-build
        path: dist/
        
    - name: ğŸ” SEO Validation
      run: |
        echo "ğŸ” Checking SEO elements..."
        
        FILES=("dist/index.html" "dist/products.html" "dist/about.html" "dist/contact.html")
        
        for file in "${FILES[@]}"; do
          echo "Checking: $file"
          
          # Check for title tag
          if grep -q "<title>" "$file"; then
            echo "âœ… Title tag found in $file"
          else
            echo "âš ï¸ Missing title tag in $file"
          fi
          
          # Check for meta description
          if grep -q 'name="description"' "$file"; then
            echo "âœ… Meta description found in $file"
          else
            echo "âš ï¸ Missing meta description in $file"
          fi
          
          # Check for Open Graph tags
          if grep -q 'property="og:' "$file"; then
            echo "âœ… Open Graph tags found in $file"
          else
            echo "âš ï¸ Missing Open Graph tags in $file"
          fi
        done
        
        echo "âœ… SEO validation completed"
        
    - name: ğŸ›¡ï¸ Security Check
      run: |
        echo "ğŸ›¡ï¸ Checking security configurations..."
        
        # Check for inline scripts (should be minimal)
        if grep -r "javascript:" dist/ 2>/dev/null; then
          echo "âš ï¸ Found javascript: protocols (security risk)"
        else
          echo "âœ… No javascript: protocols found"
        fi
        
        # Check for external links security
        if grep -r 'target="_blank"' dist/ | grep -v 'rel="noopener noreferrer"' 2>/dev/null; then
          echo "âš ï¸ External links without proper security attributes"
        else
          echo "âœ… External links properly secured"
        fi
        
        echo "âœ… Security check completed"
        
    - name: ğŸ“Š Performance Preview
      run: |
        echo "ğŸ“Š Performance indicators:"
        
        # File size analysis
        echo "ğŸ“ CSS size: $(stat -f%z dist/assets/css/style.css 2>/dev/null || stat -c%s dist/assets/css/style.css) bytes"
        echo "ğŸ“ JS size: $(stat -f%z dist/assets/js/site.js 2>/dev/null || stat -c%s dist/assets/js/site.js) bytes"
        
        # Count resources
        echo "ğŸ“Š HTML pages: $(find dist/ -name "*.html" | wc -l)"
        echo "ğŸ“Š CSS files: $(find dist/ -name "*.css" | wc -l)"
        echo "ğŸ“Š JS files: $(find dist/ -name "*.js" | wc -l)"
        echo "ğŸ“Š Images: $(find dist/ -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.svg" | wc -l)"
        
        echo "âœ… Ready for production deployment!"